// Entry point for running the app without electron
import Logger from './logger';
import Servers from './routes.js';
import {getSetting} from './settings.js';

/*
 * If running on the same machine as plotly on-premise,
 * then we do not need to verify SSL certificates as
 * requests to plotly will never leave the server.
 *
 * This is to allow users to use Plotly On-Prem with
 * a self-signed certificate generated by replicated
 * or by themselves without actually specifying the
 * path of the actual certificate.
 * See https://github.com/plotly/streambed/issues/8948.
 *
 * Note: if any requests are made to other domains
 * or if any other services end up running inside
 * this docker container, then this setting should
 * be applied on a request-by-request basis as an
 * argument of the `fetch` `agent` instead of
 * set as a process variable.
 */
if (getSetting('IS_RUNNING_INSIDE_ON_PREM')) {
    process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
}

const servers = new Servers();
Logger.log('Starting server', 2);
servers.httpServer.start();
Logger.log('Loading persistent queries', 2);
servers.httpsServer.queryScheduler.loadQueries();
